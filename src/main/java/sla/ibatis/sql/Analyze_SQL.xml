<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >

<sqlMap namespace="Analyze">
	<typeAlias alias="KeyCount" type="sla.model.KeyCount"/>
	<typeAlias alias="ShortUserInfoWithCount" type="sla.model.ShortUserInfoWithCount"/>
	<select id="getCountRecordByUser" parameterClass="Map" resultClass="ShortUserInfoWithCount">
	SELECT u.id,u.social_name  ,c.cnt AS cnt FROM (SELECT user_id, SUM(cnt) 
	cnt FROM(SELECT a.*, (SELECT COALESCE(SUM(visit_count),0)
 	FROM visit_count WHERE encoded_key_id=a.id  AND (time_period BETWEEN #startPeriod# AND #endPeriod#)) 
 	AS cnt FROM short_url a WHERE url=#url# ORDER BY cnt DESC ) count_by_user GROUP BY user_id ORDER BY cnt DESC) c
 	,user_info u WHERE c.user_id=u.id ORDER BY c.cnt DESC
	</select>
	<select id="getUserGenderDistribution" parameterClass="Map" resultClass="KeyCount">
	SELECT key_id ,key_name,COALESCE(cnt,0) AS cnt FROM (SELECT 1 AS key_id,#key0# AS key_name FROM DUAL UNION SELECT 2 AS key_id,#key1# AS key_name FROM DUAL UNION SELECT 3 AS key_id,#key2# AS key_name FROM DUAL) a
 	LEFT JOIN (SELECT social_gender AS key_name,COUNT(*) AS cnt FROM user_info WHERE id IN 
 	(SELECT user_id FROM short_url WHERE url=#url#) GROUP BY social_gender) b USING(key_name)
	</select>
</sqlMap>